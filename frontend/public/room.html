<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rooms | E-Hotel</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    .filter-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .filter-group select, .filter-group input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    .room-card {
      display: none;
    }
  </style>
</head>
<body>

<!-- NAVIGATION -->
<header class="navbar">
  <a href="index.html">
    <img src="images/logo.png" alt="E-Hotel Logo" class="logo" />
  </a>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="contact.html">Contact Us</a>
    <a href="room.html">Rooms</a>
    <a href="about.html">About Us</a>
    <a href="profile.html">Profile</a>
    <a href="login.html"><button class="login-button">Login</button></a>
    <a href="hotel-statistics.html">Hotel Statistics</a>
  </nav>
</header>

<main class="rooms-section">
  <h1 class="page-title">Rooms</h1>

  <!-- Filter Section -->
  <div class="filter-group">
    <select id="capacityFilter" required>
      <option value="">Capacity</option>
      <option value="Single">Single</option>
      <option value="Double">Double</option>
      <option value="Family">Family</option>
      <option value="Suite">Suite</option>
    </select>

    <select id="viewFilter" required>
      <option value="">View</option>
      <option value="sea">Sea</option>
      <option value="mountain">Mountain</option>
      <option value="both">Both</option>
      <option value="none">None</option>
    </select>

    <select id="chainFilter" required>
      <option value="">Hotel Chain</option>
      <option value="Luxury Stays">Luxury Stays</option>
      <option value="Budget Inns">Budget Inns</option>
      <option value="Elite Resorts">Elite Resorts</option>
      <option value="Urban Hotels">Urban Hotels</option>
      <option value="Travel Comfort">Travel Comfort</option>
    </select>

    <select id="extendableFilter">
      <option value="">Extendable</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <select id="areaFilter">
      <option value="">Area</option>
      <option value="New York - 5th Avenue">New York - 5th Avenue</option>
      <option value="Los Angeles - Sunset Blvd">Los Angeles - Sunset Blvd</option>
      <option value="Toronto - Bay Street">Toronto - Bay Street</option>
    </select>

    <select id="categoryFilter">
      <option value="">Category</option>
      <option value="1">★</option>
      <option value="2">★★</option>
      <option value="3">★★★</option>
      <option value="4">★★★★</option>
      <option value="5">★★★★★</option>
    </select>

    <!-- Two date filters: start date and end date -->
    <input type="date" id="startDateFilter" />
    <input type="date" id="endDateFilter" />
  </div>

  <!-- Room Grid -->
  <section id="roomGrid" class="room-grid"></section>
</main>

<script>
  // Update filters object to include both start and end dates.
  const filters = {
    capacity: '',
    view: '',
    chain: '',
    extendable: '',
    area: '',
    category: '',
    startDate: '',
    endDate: ''
  };

  const capacityImages = {
    Single: 'images/Single.jpeg',
    Double: 'images/Double.jpeg',
    Family: 'images/Family.jpeg',
    Suite: 'images/Suite.jpeg'
  };

  const roomGrid = document.getElementById('roomGrid');
  let hotelsById = {};

  // Updated applyFilters to include startDate and endDate
  const applyFilters = () => {
  const roomCards = document.querySelectorAll('.room-card');
  const isAnyFilterActive = Object.values(filters).some(val => val !== '');

  roomCards.forEach(card => {
    const matches = 
      (!filters.capacity || card.dataset.capacity === filters.capacity) &&
      (!filters.view || card.dataset.view === filters.view) &&
      (!filters.chain || card.dataset.chain.toLowerCase().trim() === filters.chain.toLowerCase().trim()) &&
      (!filters.extendable || card.dataset.extendable === filters.extendable) &&
      (!filters.area || card.dataset.area.toLowerCase().trim() === filters.area.toLowerCase().trim()) &&
      (!filters.category || card.dataset.category === filters.category);
      // The startDate and endDate conditions have been removed.

    card.style.display = (isAnyFilterActive && matches) ? 'block' : 'none';
  });
};


  const fetchHotelsAndRooms = async () => {
    try {
      const [hotelRes, roomRes, bookingRes] = await Promise.all([
        fetch('http://localhost:5001/hotel'),
        fetch('http://localhost:5001/room'),
        fetch('http://localhost:5001/booking')
      ]);

      const [hotels, rooms, bookings] = await Promise.all([
        hotelRes.json(),
        roomRes.json(),
        bookingRes.json()
      ]);

      hotels.forEach(hotel => {
        hotelsById[hotel.hotelid] = hotel;
      });

      roomGrid.innerHTML = '';

      rooms.forEach(room => {
        const imgSrc = capacityImages[room.capacity] || 'images/default.jpeg';
        const hotel = hotelsById[room.hotelid];
        const area = hotel?.hotel_city && hotel?.hotel_streetname
          ? `${hotel.hotel_city.trim()} - ${hotel.hotel_streetname.trim()}`
          : '';

        const card = document.createElement('div');
        card.className = 'room-card';
        card.dataset.capacity = room.capacity;
        card.dataset.chain = hotel?.chainname?.trim() || 'Unknown';
        card.dataset.view = room.seaview && room.mountainview
          ? 'both'
          : room.seaview
          ? 'sea'
          : room.mountainview
          ? 'mountain'
          : 'none';
        card.dataset.extendable = room.extendable ? 'yes' : 'no';
        card.dataset.area = area;
        card.dataset.category = hotel?.category?.toString() || '';

        // Here we assign placeholder available dates. Replace these with actual data if available.
        card.dataset.startDate = '2025-04-01';
        card.dataset.endDate = '2025-04-05';

        card.innerHTML = `
          <img src="${imgSrc}" alt="${room.capacity} Room" class="room-image" />
          <h2>${hotel?.chainname || 'No Chain'} - ${room.capacity}</h2>
          <p>
            Capacity: ${room.capacity}<br/>
            Price: $${Number(room.price).toFixed(2)}<br/>
            Category: ${hotel?.category ? '★'.repeat(hotel.category) : 'Unrated'}<br/>
            Location: ${hotel?.hotel_streetnumber || ''} ${hotel?.hotel_streetname || ''}, ${hotel?.hotel_city || ''}, ${hotel?.hotel_country || ''}
          </p>
          <div style="text-align: right; padding: 0 16px 16px;">
            <button onclick="bookRoom(${room.roomid}, ${room.roomnumber})">Book</button>
          </div>
        `;
        roomGrid.appendChild(card);
      });

      applyFilters();
    } catch (error) {
      console.error('Error:', error);
    }
  };

  // Book room function with hardcoded customerID and current date values.
  const bookRoom = async (roomID, roomNumber) => {
    const today = new Date().toISOString().split("T")[0]; // Get today's date in YYYY-MM-DD format
    const customerID = "101"; // Hardcoded customer ID

    try {
      const res = await fetch("http://localhost:5001/book-room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customerID, roomID, roomNumber, startdate: today, enddate: today })
      });

      const data = await res.json();
      if (res.ok) {
        alert(`Booking successful! ID: ${data.bookingID}`);
      } else {
        alert(`Booking failed: ${data.error}`);
      }
    } catch (error) {
      alert("Booking failed due to a network error.");
    }
  };

  // Add event listeners for all filter inputs
  document.querySelectorAll('.filter-group select, .filter-group input').forEach(filter => {
    filter.addEventListener('change', e => {
      // Get the filter key from the element's ID (e.g., "capacityFilter" => "capacity")
      const key = e.target.id.replace('Filter', '');
      // Lowercase first letter to match our filters object keys (e.g., "startDate" remains "startDate")
      const filterKey = key.charAt(0).toLowerCase() + key.slice(1);
      filters[filterKey] = e.target.value;
      applyFilters();
    });
  });

  fetchHotelsAndRooms();
</script>
</body>
</html>
